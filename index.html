<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Date du b√¢ti</title>


    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
    integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
    crossorigin=""/>

    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
        }
    </style>

</head>
<body>

   <div id="map"></div>

   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

   <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
   integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
   crossorigin=""></script>

   <script src="http://makinacorpus.github.io/Leaflet.RestoreView/leaflet.restoreview.js"></script>
   <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

   <script>
      var module = { exports: {} };
    </script>
   <script src="https://unpkg.com/spin@0.0.1"></script>
   <script src="https://unpkg.com/leaflet-spin@1.1.0/leaflet.spin.min.js"></script>


   <script>

    var map = L.map('map');

    if (!map.restoreView()) {
        map.setView([47.651, 2.791], 6);
    }

    L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png').addTo(map);
    var layers = []


    $('#map').on('click', '.trigger', function() {
        alert("TODO");
    });

    var loadgeoJSON = function(filepath) {
        map.spin(true);
        $.getJSON(filepath, function(json) {
            for (r in layers) {
                if (layers[r].options.filepath == filepath) {
                    map.spin(false);
                    return;
                }
            }
            layers.push(L.geoJSON(json, {
                filepath: filepath,

                style: function(feature) {
                    return {color: feature.properties.color};
                },
                onEachFeature: function (feature, layer) {
                    var link = `${feature.properties.insee} - ${feature.properties.name}<br>${feature.properties.description}<br><button class="trigger">Refresh</button>`
                    layer.bindPopup(link);
                }
            }).addTo(map));
            map.spin(false);
        });
    };

    let france;
    map.spin(true);
    $.getJSON('./data/stats/france.geojson', function(json) {
        france = L.geoJSON(json);//.addTo(map);
        onmove(null);
        map.spin(false);
    });

    var onmove = function(e) {
        current = []
        for (var l in layers) current.push(layers[l].options.filepath);

        newer = []
        var results = leafletPip.pointInLayer(map.getCenter(), france);
        for (var r in results) {
            var path = './data/stats/' + results[r].feature.properties.insee.substring(0,2) + '.geojson';
            if (newer.indexOf(path)==-1) newer.push(path);
        }

        if (JSON.stringify(newer) !== JSON.stringify(current)) {
            map.spin(true);
            for (var l in layers) map.removeLayer(layers[l]);
            layers = [];

            for (var p in newer)
                loadgeoJSON(newer[p]);
            map.spin(false);
        }

    };

    map.on('moveend', onmove);
</script>

</body>
</html>
